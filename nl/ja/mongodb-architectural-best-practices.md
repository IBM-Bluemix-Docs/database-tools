---
copyright:
  years: 1994, 2017
lastupdated: "2017-11-27"
---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}

# MongoDB - アーキテクチャーのベスト・プラクティス

{{site.data.keyword.cloud}} 上のデプロイメントで {{site.data.keyword.mongodb}} を使用するために、以下のベスト・プラクティスを使用してください。エンジニアリング・サーバーを選択した場合、これらの推奨事項のいくつかはすでに実装されています。 

## デプロイメント戦略

{{site.data.keyword.mongodb}} のデプロイメントを計画する場合、いくつかの重要な領域について検討する必要があります。最も重要な領域は、データ・セットの現行サイズと予想されるサイズです。この 2 つの領域は、個々の物理ノード・リソースのニーズを選択するための主な要因であり、シャーディング・プランの指針となります。また、データの重要性も考慮する必要があり、どの程度のデータの損失や遅れの可能性を許容できるかを検討する必要があります (特に、複製シナリオの場合)。 
## メモリーのサイジング

{{site.data.keyword.mongodb}} は、多くのデータ指向アプリケーションと同様に、データ・セットがメモリー内に常駐している場合に最も効率的に機能します。ディスク入出力の必要がない {{site.data.keyword.mongodb}} インスタンスより優れたパフォーマンスが得られるものはありません。可能な限り、使用可能な RAM が作業データ・セットのサイズを上回っているプラットフォームを選択してください。データ・セットが単一ノードの使用可能な RAM を超える場合、シャーディングの利用を考えてください。シャーディングは、クラスター内の使用可能な RAM の量を増やし、より大きなデータ・セットを収容できるようにします。これにより、デプロイメントの全体的なパフォーマンスを最大化できます。ページ不在は、デプロイメントの使用可能な RAM を超えている可能性があることを示す場合があります。使用可能な RAM を増やすことを検討する必要があります。

## ディスク・タイプ

速度は問題ではない場合、あるいは使用可能メモリー戦略でサポートできる大きさを超えるデータ・セットがある場合、デプロイメントに適切なディスク・タイプを使用することが重要です。IOPS がディスク・タイプの選択の鍵になります。IOPS が高いほど、{{site.data.keyword.mongodb}} のパフォーマンスが優れています。 ネットワーク・ストレージは、デプロイメントの長い待ち時間およびパフォーマンスの低下の原因になるため、可能であれば、ローカル・ディスクを使用する必要があります。ディスク・アレイには RAID 10 を使用することをお勧めします。

## CPU

map-reduce を使用する場合、クロック速度と使用可能なプロセッサー数が検討対象となります。ただし、ほとんどのデータをメモリー内で使用して {{site.data.keyword.mongodb}} インスタンスを実行する場合は、クロック速度がパフォーマンスに影響する可能性があります。このような環境下でシステムを実行し、1 秒当たりの動作を最大化したい場合は、高クロック/バス速度の CPU を組み込んだデプロイメント戦略を検討してください。

## 複製

複製は、クラスター内のノードに障害が発生した場合に、データの高可用性を実現します。各 {{site.data.keyword.mongodb}} デプロイメントで、少なくとも 3 つのノードを使用して複製することをお勧めします。3 つのノードを使用した複製の最も一般的な構成は、2x1 デプロイメントです。つまり、1 つのデータ・センターに 1 次ノードを 2 つ配置し、2 次データ・センターにバックアップ・サーバーを 1 つ配置します。


## シャーディング

大きなデータ・セットが予想される場合は、シャード {{site.data.keyword.mongodb}} デプロイメントをデプロイすることをお勧めします。シャーディングを使用すると、複数のノード間にデータ・セットを区分できます。{{site.data.keyword.mongodb}} は、データを自動的にクラスター内のノード間に分散することができます。あるいは、シャード・キーを定義し、そのキーに対して、範囲に基づいたシャーディングを作成できます。シャーディングは書き込みパフォーマンスに役立つため、データ・セットが小さい場合でも、多数の更新または挿入を必要とする場合は、シャードを行うことができます。シャード・セットをデプロイする場合、{{site.data.keyword.mongodb}} では、3 つの構成サーバー・インスタンスのみ必要です。これらは、現行シャード構成のトラッキング専用の Mongo ランタイムです。これらのノードのいずれかが失われると、クラスターは構成に対してのみ読み取り専用モードになり、構成変更を行うには、その前にすべてのノードをオンラインに戻すことが必要になります。

## 書き込み安全モード

{{site.data.keyword.mongodb}} がディスクへのデータの持続性を処理する方法を制御する、いくつかの書き込み安全モードがあります。データ保全性とパフォーマンスの両方にとって、どの戦略がニーズに最適かを検討することが重要です。使用可能な書き込み安全モードは、次のとおりです。

* **None** – ハイパフォーマンスに役立つ、非ブロッキングの据え置き書き込み戦略を提供します。ただし、ノード障害でデータが失われる可能性が多少あります。また、クラスター内の 1 つのノードに書き込まれたデータが、読み取り整合性のためにそのクラスター内のすべてのノードで即時に使用可能にならない可能性もあります。「None」モードでは、ネットワーク障害に対するデータ保護は提供されません。このモードは信頼性が極めて低いため、その使用は、パフォーマンスが優先されてデータ保全性は問題ではない場合に限ってください。
* **Normal** – {{site.data.keyword.mongodb}} のデフォルトです。「Normal」モードも、非ブロッキング据え置き書き込み戦略です。  
* **Safe** – {{site.data.keyword.mongodb}} が書き込み要求を受け取ったことを確認するまでブロックしますが、書き込みが実行されるまではブロックしません。「Safe」モードは、より高度なレベルのデータ保全性とクラスター内の読み取り整合性を提供します。
* **Journal Safe** – {{site.data.keyword.mongodb}} のリカバリー・オプションを提供します。「Journal Safe」モードでは、データが確認済みであること、および制御が戻る前にジャーナルの更新が実行されたことが保証されます。
* **Fsync** – 最高レベルのデータ保全性が提供され、データの物理書き込みが実行されるまでブロックされます。「Fsync」の使用はパフォーマンスの低下を伴うため、アプリケーションのデータ保全性が主要な関心事である場合にのみ使用してください。

## デプロイメントのテスト

10gen には、デプロイメントのロード・テストに役立ついくつかのツールが用意されています。コンソール・ツール「benchrun」は、JavaScript テスト・ハーネス内から操作を実行できます。Benchrun は、操作に関する情報と各操作の待ち時間数を返します。{{site.data.keyword.mongodb}} インスタンスについて詳細情報が必要な場合は、`mongostat` コマンドまたは MMS を実行して、テスト中にデプロイメントをモニターすることを検討してください。これらツールについて詳しくは、以下のリファレンスを参照してください。

[MongoStat 概要](http://docs.mongodb.org/manual/reference/mongostat/)

[10gen の {{site.data.keyword.mongodb}} モニタリング・サービス](http://www.10gen.com/products/mongodb-monitoring-service)

## インストール

安定したパフォーマンス指向のソリューションの作成に役立つ {{site.data.keyword.mongodb}} をインストールする場合、いくつかの考慮事項があります。10gen では、可能な限り CentOS (64 ビット) を使用することを推奨しています。32 ビット・オペレーティング・システムおよび Windows オペレーティング・システムにはデプロイしないようにしてください。これらのシステムで提供されるデプロイメント・プラットフォームは不適切です。32 ビット・オペレーティング・システムにはファイル・サイズ制限があり、これが問題の原因になります。Windows では、デプロイメント内の RAM の不足を補うために OS  が仮想メモリーを使用した場合に、パフォーマンス問題が生じることがあります。デフォルトでは、{{site.data.keyword.cloud_notm}} は、すべてのエンジニアリング・サーバー・デプロイメントに対して、CentOS 64 ビット・オペレーティング・システムを提供しています。

また、パフォーマンスを最大化するために、基本 OS インストールに対して以下の変更を行ってください。
* **SSD 先読みのデフォルトを 16 ブロックに設定** – SSD ドライブはシーク時間が優れているため、先読みを 16 ブロックに縮小することが可能です。回転ディスクには多少のバッファリングが必要になることがあるため、これらのディスクは 32 ブロックに設定されます。
* **noatime** – 「Noatime」を使用することで、システムは読み取り中のファイルをファイル・システムに書き込む必要がなくなります。つまり、ファイル・アクセスが高速になり、ディスクの摩耗が軽減されます。
* **BIOS で NUMA をオフ** – Linux、NUMA、および {{site.data.keyword.mongodb}} は、通常は連携しません。NUMA ハードウェア上で {{site.data.keyword.mongodb}} を実行している場合は、NUMA (インターリーブ・メモリー・ポリシーを使用して実行している) をオフにすることをお勧めします。そうしないと、大幅なスローダウンや高いシステム CPU 時間などの問題が現れる可能性があります。
* **ulimit の設定** – ulimit は、オープン・ファイルの場合は 64000、ユーザー・プロセスの場合は 32000 に設定されます。これらの制限により、使用可能なファイル・ハンドルやユーザー・プロセスの不足が原因での障害を防ぐことができます。 
* **ext4 の使用** – Ext3 は、ファイルの割り振り (または、ファイルの削除) が低速です。また、大きいファイル内のアクセスも、ext3 では低下します。

**注:** デフォルトでは、これらの変更はすべての {{site.data.keyword.cloud_notm}} サーバーで設定されます。

ジャーナル・ボリュームとデータ・ボリュームを別々の物理ボリュームにすることもお勧めします。ジャーナル・ディレクトリーとデータ・ディレクトリーが同じ物理ボリュームに存在すると、ジャーナルへのフラッシュによりデータのアクセスが中断され、{{site.data.keyword.mongodb}} デプロイメント内で長い待ち時間のスパイクが発生します。

## 運用

{{site.data.keyword.mongodb}} デプロイメントを実動にプロモートした後、モニタリングおよびパフォーマンス最適化のためにいくつかの推奨事項があります。 
* MMS エージェントを {{site.data.keyword.mongodb}} のすべてのインスタンス上で実行していることを確認してください。これは、デプロイメントの正常性およびパフォーマンスをモニターするのに役立ちます。サポートの対話時に、MMS エージェントは有用なデバッグ・データを 10gen に提供します。 
* `mongostat` コマンドも、MongoDB ノードのパフォーマンスに関するランタイム情報を提供します。

これらのツールのいずれかでパフォーマンス問題が検出された場合、シャーディングまたは索引付けを使用すると、これらのパフォーマンス問題を修正できることがあります。 

* 索引 -  モニタリング・ツールにより、フィールドに基づく照会の動作不良が示された場合、MongoDB デプロイメント用の索引を作成してください。パフォーマンスを向上させるために、個別のフィールドに基づくデータを照会する際には、常に索引を使用してください。
* シャーディング - 操作するデータ・セットが大きいためにノードの全体的パフォーマンスが低下する場合は、シャーディングを使用してください。限界に達する前に、必ずシャードを行ってください。システムは、挿入時または更新時のシャーディングの場合にのみチャンクを分割します。シャードを長く待ちすぎると、不均等な分配になることがあります。 

## まとめ

これらのベスト・プラクティスは、発生する可能性があるすべてのシナリオに対応するものではありません。10gen サブスクリプションを使用して 10gen から直接サポートにアクセスするか、MongoDB Web サイトにある資料を参照して特定の問題や懸念に役立てるのが常に最善の方法です。
